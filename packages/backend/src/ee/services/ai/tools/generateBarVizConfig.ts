import {
    Explore,
    getTotalFilterRules,
    isSlackPrompt,
    toolVerticalBarArgsSchema,
    toolVerticalBarArgsSchemaTransformed,
    ToolVerticalBarArgsTransformed,
} from '@lightdash/common';
import { tool } from 'ai';
import type {
    CreateOrUpdateArtifactFn,
    GetExploreFn,
    GetPromptFn,
    RunMiniMetricQueryFn,
    SendFileFn,
    UpdateProgressFn,
    UpdatePromptFn,
} from '../types/aiAgentDependencies';
import { renderEcharts } from '../utils/renderEcharts';
import { toolErrorHandler } from '../utils/toolErrorHandler';
import {
    validateCustomMetricsDefinition,
    validateFilterRules,
    validateMetricDimensionFilterPlacement,
    validateSelectedFieldsExistence,
} from '../utils/validators';
import { renderVerticalBarViz } from '../visualizations/vizVerticalBar';

type Dependencies = {
    getExplore: GetExploreFn;
    updateProgress: UpdateProgressFn;
    runMiniMetricQuery: RunMiniMetricQueryFn;
    getPrompt: GetPromptFn;
    updatePrompt: UpdatePromptFn;
    sendFile: SendFileFn;
    createOrUpdateArtifact: CreateOrUpdateArtifactFn;
    maxLimit: number;
};

export const getGenerateBarVizConfig = ({
    getExplore,
    updateProgress,
    runMiniMetricQuery,
    getPrompt,
    sendFile,
    updatePrompt,
    createOrUpdateArtifact,
    maxLimit,
}: Dependencies) => {
    const schema = toolVerticalBarArgsSchema;

    /**
     * This function is used to validate the viz tool.
     * @param vizTool - The complete viz tool with populated custom fields
     * @param explore - The explore
     */
    const validateVizTool = (
        vizTool: ToolVerticalBarArgsTransformed,
        explore: Explore,
    ) => {
        const filterRules = getTotalFilterRules(vizTool.filters);
        const fieldsToValidate = [
            vizTool.vizConfig.xDimension,
            vizTool.vizConfig.breakdownByDimension,
            ...vizTool.vizConfig.yMetrics,
            ...vizTool.vizConfig.sorts.map((sortField) => sortField.fieldId),
        ].filter((x) => typeof x === 'string');
        validateSelectedFieldsExistence(
            explore,
            fieldsToValidate,
            vizTool.customMetrics,
        );
        validateCustomMetricsDefinition(explore, vizTool.customMetrics);
        validateFilterRules(explore, filterRules);
        // TODO: Enhance filter validation to support custom metrics
        // Current validateFilterRules and validateMetricDimensionFilterPlacement only validate
        // against explore fields. We need to extend these validators to also consider custom metrics
        // when validating filter rules to ensure filters can reference custom metrics appropriately.
        validateMetricDimensionFilterPlacement(explore, vizTool.filters);
    };

    return tool({
        description: toolVerticalBarArgsSchema.description,
        parameters: schema,
        execute: async (toolArgs) => {
            try {
                await updateProgress('ðŸ“Š Generating your bar chart...');

                // TODO: common for all viz tools. find a way to reuse this code.
                const vizTool =
                    toolVerticalBarArgsSchemaTransformed.parse(toolArgs);
                const explore = await getExplore({
                    exploreName: vizTool.vizConfig.exploreName,
                });
                validateVizTool(vizTool, explore);
                // end of TODO

                const prompt = await getPrompt();

                await createOrUpdateArtifact({
                    threadUuid: prompt.threadUuid,
                    promptUuid: prompt.promptUuid,
                    artifactType: 'chart',
                    title: toolArgs.title,
                    description: toolArgs.description,
                    vizConfig: toolArgs,
                });

                // TODO :: keeping this for now, until the front-end is under feature-flag
                await updatePrompt({
                    promptUuid: prompt.promptUuid,
                    vizConfigOutput: toolArgs,
                });

                if (isSlackPrompt(prompt)) {
                    const { chartOptions } = await renderVerticalBarViz({
                        runMetricQuery: (q) => runMiniMetricQuery(q, maxLimit),
                        vizTool,
                        maxLimit,
                    });

                    const file = await renderEcharts(chartOptions);
                    await updateProgress('âœ… Done.');

                    const sentfileArgs = {
                        channelId: prompt.slackChannelId,
                        threadTs: prompt.slackThreadTs,
                        organizationUuid: prompt.organizationUuid,
                        title: 'Generated by Lightdash',
                        comment: `Bar chart generated by Lightdash`,
                        filename: 'lightdash-query-results.png',
                        file,
                    };
                    await sendFile(sentfileArgs);
                }

                return `Success`;
            } catch (e) {
                return toolErrorHandler(e, `Error generating bar chart.`);
            }
        },
    });
};
