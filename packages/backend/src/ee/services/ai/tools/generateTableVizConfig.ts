import {
    isSlackPrompt,
    metricQueryTableViz,
    toolTableVizArgsSchema,
    toolTableVizArgsSchemaTransformed,
} from '@lightdash/common';
import { tool } from 'ai';
import type {
    CreateOrUpdateArtifactFn,
    GetExploreFn,
    GetPromptFn,
    RunMiniMetricQueryFn,
    SendFileFn,
    UpdateProgressFn,
} from '../types/aiAgentDependencies';
import { convertQueryResultsToCsv } from '../utils/convertQueryResultsToCsv';
import { populateCustomMetricsSQL } from '../utils/populateCustomMetricsSQL';
import { serializeData } from '../utils/serializeData';
import { toolErrorHandler } from '../utils/toolErrorHandler';
import { validateTableVizConfig } from '../utils/validateTableVizConfig';

type Dependencies = {
    getExplore: GetExploreFn;
    updateProgress: UpdateProgressFn;
    runMiniMetricQuery: RunMiniMetricQueryFn;
    getPrompt: GetPromptFn;
    sendFile: SendFileFn;
    createOrUpdateArtifact: CreateOrUpdateArtifactFn;
    maxLimit: number;
    enableDataAccess: boolean;
};

export const getGenerateTableVizConfig = ({
    getExplore,
    runMiniMetricQuery,
    getPrompt,
    sendFile,
    updateProgress,
    createOrUpdateArtifact,
    maxLimit,
    enableDataAccess,
}: Dependencies) =>
    tool({
        description: toolTableVizArgsSchema.description,
        inputSchema: toolTableVizArgsSchema,
        execute: async (toolArgs) => {
            try {
                await updateProgress('ðŸ”¢ Querying the data...');

                // TODO: common for all viz tools. find a way to reuse this code.
                const vizTool =
                    toolTableVizArgsSchemaTransformed.parse(toolArgs);

                const explore = await getExplore({
                    exploreName: vizTool.vizConfig.exploreName,
                });

                validateTableVizConfig(vizTool, explore);
                // end of TODO

                const prompt = await getPrompt();

                // Create or update artifact
                await createOrUpdateArtifact({
                    threadUuid: prompt.threadUuid,
                    promptUuid: prompt.promptUuid,
                    artifactType: 'chart',
                    title: toolArgs.title,
                    description: toolArgs.description,
                    vizConfig: toolArgs,
                });

                const metricQuery = metricQueryTableViz({
                    vizConfig: vizTool.vizConfig,
                    filters: vizTool.filters,
                    maxLimit,
                    customMetrics: vizTool.customMetrics ?? null,
                });
                const queryResults = await runMiniMetricQuery(
                    metricQuery,
                    maxLimit,
                    populateCustomMetricsSQL(vizTool.customMetrics, explore),
                );
                await updateProgress('âœ… Done.');

                const rowCount = queryResults.rows.length;
                const csv = convertQueryResultsToCsv(queryResults);

                // Always send CSV file to Slack if it's a Slack prompt, unless there are no results
                if (isSlackPrompt(prompt) && rowCount > 0) {
                    await sendFile({
                        channelId: prompt.slackChannelId,
                        threadTs: prompt.slackThreadTs,
                        organizationUuid: prompt.organizationUuid,
                        title: 'Generated by Lightdash',
                        comment: `CSV results generated by Lightdash`,
                        filename: 'lightdash-query-results.csv',
                        file: Buffer.from(csv, 'utf8'),
                    });
                }

                if (rowCount === 0) {
                    return `The query returned no results`;
                }

                if (!enableDataAccess) {
                    if (rowCount === 1) {
                        return `Here's the result:\n${serializeData(
                            csv,
                            'csv',
                        )}`;
                    }

                    return `Success`;
                }

                return serializeData(csv, 'csv');
            } catch (e) {
                return toolErrorHandler(
                    e,
                    `Error generating table visualization`,
                );
            }
        },
    });
