{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "https://schemas.lightdash.com/lightdash/chart-as-code.json",
    "title": "Lightdash Chart as Code",
    "description": "Schema for defining Lightdash charts in YAML format for version control",
    "type": "object",
    "additionalProperties": false,
    "required": [
        "name",
        "tableName",
        "metricQuery",
        "slug",
        "spaceSlug",
        "version"
    ],
    "properties": {
        "version": {
            "type": "number",
            "description": "Schema version for this chart configuration",
            "const": 1
        },
        "name": {
            "type": "string",
            "description": "Display name of the chart",
            "minLength": 1
        },
        "description": {
            "type": "string",
            "description": "Optional description of what this chart displays"
        },
        "slug": {
            "type": "string",
            "description": "Unique identifier slug for this chart",
            "pattern": "^[a-z0-9-]+$"
        },
        "spaceSlug": {
            "type": "string",
            "description": "Path to the space containing this chart (e.g., 'sales/reports' or 'marketing')"
        },
        "tableName": {
            "type": "string",
            "description": "The explore/table name this chart queries from"
        },
        "dashboardSlug": {
            "type": ["string", "null"],
            "description": "Optional dashboard slug if this chart is saved within a dashboard",
            "pattern": "^[a-z0-9-]+$"
        },
        "updatedAt": {
            "type": "string",
            "format": "date-time",
            "description": "Timestamp when the chart was last updated (readonly)"
        },
        "downloadedAt": {
            "type": "string",
            "format": "date-time",
            "description": "Timestamp when this chart was downloaded from Lightdash (readonly)"
        },
        "metricQuery": {
            "type": "object",
            "description": "The query configuration defining what data to fetch",
            "additionalProperties": false,
            "required": ["exploreName"],
            "properties": {
                "exploreName": {
                    "type": "string",
                    "description": "The name of the explore to query"
                },
                "dimensions": {
                    "type": "array",
                    "description": "List of dimension field IDs to include",
                    "items": {
                        "type": "string"
                    }
                },
                "metrics": {
                    "type": "array",
                    "description": "List of metric field IDs to include",
                    "items": {
                        "type": "string"
                    }
                },
                "filters": {
                    "type": "object",
                    "description": "Filter rules to apply to the query using 'and'/'or' filter groups",
                    "additionalProperties": false,
                    "properties": {
                        "dimensions": {
                            "oneOf": [
                                {
                                    "type": "array",
                                    "description": "Empty dimensions filter array (no filters applied)",
                                    "maxItems": 0
                                },
                                {
                                    "type": "object",
                                    "description": "Dimension filter group",
                                    "additionalProperties": false,
                                    "properties": {
                                        "id": {
                                            "type": "string",
                                            "description": "Optional unique identifier for the filter group"
                                        },
                                        "and": {
                                            "type": "array",
                                            "description": "Array of filters combined with AND logic",
                                            "items": {
                                                "type": "object",
                                                "additionalProperties": false,
                                                "required": [
                                                    "target",
                                                    "operator"
                                                ],
                                                "properties": {
                                                    "id": {
                                                        "type": "string",
                                                        "description": "Optional unique identifier for the filter"
                                                    },
                                                    "target": {
                                                        "type": "object",
                                                        "additionalProperties": false,
                                                        "required": ["fieldId"],
                                                        "properties": {
                                                            "fieldId": {
                                                                "type": "string",
                                                                "description": "Field ID to filter on"
                                                            },
                                                            "fieldFilterType": {
                                                                "type": "string",
                                                                "description": "Filter type hint (e.g., 'date' for date fields)"
                                                            }
                                                        }
                                                    },
                                                    "operator": {
                                                        "type": "string",
                                                        "description": "Filter operator",
                                                        "enum": [
                                                            "equals",
                                                            "notEquals",
                                                            "isNull",
                                                            "notNull",
                                                            "startsWith",
                                                            "endsWith",
                                                            "include",
                                                            "doesNotInclude",
                                                            "lessThan",
                                                            "lessThanOrEqual",
                                                            "greaterThan",
                                                            "greaterThanOrEqual",
                                                            "inThePast",
                                                            "notInThePast",
                                                            "inTheNext",
                                                            "inTheCurrent",
                                                            "notInTheCurrent",
                                                            "inBetween",
                                                            "notInBetween"
                                                        ]
                                                    },
                                                    "values": {
                                                        "type": "array",
                                                        "description": "Values to filter by"
                                                    },
                                                    "required": {
                                                        "type": "boolean",
                                                        "description": "Whether this filter is required"
                                                    },
                                                    "settings": {
                                                        "type": "object",
                                                        "description": "Additional settings for date/time filters",
                                                        "additionalProperties": false,
                                                        "properties": {
                                                            "unitOfTime": {
                                                                "type": "string",
                                                                "enum": [
                                                                    "milliseconds",
                                                                    "seconds",
                                                                    "minutes",
                                                                    "hours",
                                                                    "days",
                                                                    "weeks",
                                                                    "months",
                                                                    "quarters",
                                                                    "years"
                                                                ],
                                                                "description": "Time unit for relative date filters"
                                                            },
                                                            "completed": {
                                                                "type": "boolean",
                                                                "description": "For date filters, whether to include completed periods"
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        },
                                        "or": {
                                            "type": "array",
                                            "description": "Array of filters combined with OR logic",
                                            "items": {
                                                "$ref": "#/properties/metricQuery/properties/filters/properties/dimensions/oneOf/1/properties/and/items"
                                            }
                                        }
                                    }
                                }
                            ]
                        },
                        "metrics": {
                            "oneOf": [
                                {
                                    "type": "array",
                                    "description": "Empty metrics filter array (no filters applied)",
                                    "maxItems": 0
                                },
                                {
                                    "type": "object",
                                    "description": "Metric filter group",
                                    "additionalProperties": false,
                                    "properties": {
                                        "id": {
                                            "type": "string",
                                            "description": "Optional unique identifier for the filter group"
                                        },
                                        "and": {
                                            "$ref": "#/properties/metricQuery/properties/filters/properties/dimensions/oneOf/1/properties/and"
                                        },
                                        "or": {
                                            "$ref": "#/properties/metricQuery/properties/filters/properties/dimensions/oneOf/1/properties/or"
                                        }
                                    }
                                }
                            ]
                        },
                        "tableCalculations": {
                            "oneOf": [
                                {
                                    "type": "array",
                                    "description": "Empty table calculations filter array (no filters applied)",
                                    "maxItems": 0
                                },
                                {
                                    "type": "object",
                                    "description": "Table calculation filter group",
                                    "additionalProperties": false,
                                    "properties": {
                                        "id": {
                                            "type": "string",
                                            "description": "Optional unique identifier for the filter group"
                                        },
                                        "and": {
                                            "$ref": "#/properties/metricQuery/properties/filters/properties/dimensions/oneOf/1/properties/and"
                                        },
                                        "or": {
                                            "$ref": "#/properties/metricQuery/properties/filters/properties/dimensions/oneOf/1/properties/or"
                                        }
                                    }
                                }
                            ]
                        }
                    }
                },
                "sorts": {
                    "type": "array",
                    "description": "Sort configuration for query results",
                    "items": {
                        "type": "object",
                        "additionalProperties": false,
                        "required": ["fieldId", "descending"],
                        "properties": {
                            "fieldId": {
                                "type": "string",
                                "description": "Field ID to sort by"
                            },
                            "descending": {
                                "type": "boolean",
                                "description": "Sort in descending order"
                            }
                        }
                    }
                },
                "limit": {
                    "type": "number",
                    "description": "Maximum number of rows to return",
                    "minimum": 1
                },
                "metricOverrides": {
                    "type": "object",
                    "description": "Override formatting and display options for existing metrics",
                    "additionalProperties": {
                        "type": "object",
                        "additionalProperties": false,
                        "properties": {
                            "formatOptions": {
                                "type": "object",
                                "description": "Formatting configuration for the metric",
                                "additionalProperties": false,
                                "properties": {
                                    "type": {
                                        "type": "string",
                                        "enum": [
                                            "default",
                                            "currency",
                                            "number",
                                            "percent"
                                        ],
                                        "description": "Format type"
                                    },
                                    "round": {
                                        "type": "number",
                                        "description": "Number of decimal places"
                                    },
                                    "currency": {
                                        "type": "string",
                                        "description": "Currency code (e.g., USD, GBP, EUR)"
                                    },
                                    "separator": {
                                        "type": "string",
                                        "enum": [
                                            "default",
                                            "commaPeriod",
                                            "spacePeriod",
                                            "periodComma",
                                            "spaceComma"
                                        ],
                                        "description": "Thousands separator style"
                                    },
                                    "suffix": {
                                        "type": "string",
                                        "description": "Suffix to append to formatted values"
                                    },
                                    "prefix": {
                                        "type": "string",
                                        "description": "Prefix to prepend to formatted values"
                                    },
                                    "compact": {
                                        "type": "string",
                                        "enum": [
                                            "thousands",
                                            "millions",
                                            "billions",
                                            "trillions",
                                            "kilobytes",
                                            "megabytes",
                                            "gigabytes",
                                            "terabytes",
                                            "petabytes",
                                            "kibibytes",
                                            "mebibytes",
                                            "gibibytes",
                                            "tebibytes",
                                            "pebibytes"
                                        ],
                                        "description": "Compact format for large numbers (K, M, B, T) or byte units"
                                    }
                                }
                            },
                            "round": {
                                "type": "number",
                                "description": "Number of decimal places (shorthand for formatOptions.round)"
                            },
                            "format": {
                                "type": "string",
                                "description": "Format string (legacy format specification)"
                            },
                            "label": {
                                "type": "string",
                                "description": "Custom label for the metric"
                            },
                            "description": {
                                "type": "string",
                                "description": "Custom description for the metric"
                            },
                            "uuid": {
                                "type": "string",
                                "description": "UUID of the metric override"
                            }
                        }
                    }
                },
                "tableCalculations": {
                    "type": "array",
                    "description": "Custom calculations to perform on query results (like window functions)",
                    "items": {
                        "type": "object",
                        "additionalProperties": false,
                        "required": ["name", "displayName"],
                        "oneOf": [
                            {
                                "required": ["sql"],
                                "not": { "required": ["template"] }
                            },
                            {
                                "required": ["template"],
                                "not": { "required": ["sql"] }
                            }
                        ],
                        "properties": {
                            "name": {
                                "type": "string",
                                "description": "Internal name of the table calculation"
                            },
                            "displayName": {
                                "type": "string",
                                "description": "Display name shown in the UI"
                            },
                            "sql": {
                                "type": "string",
                                "description": "SQL expression for the calculation (can reference fields with ${table.field})"
                            },
                            "type": {
                                "type": "string",
                                "enum": ["string", "number", "date", "boolean"],
                                "description": "Data type of the calculation result"
                            },
                            "format": {
                                "type": "object",
                                "description": "Formatting options for the calculation",
                                "additionalProperties": false,
                                "properties": {
                                    "type": {
                                        "type": "string",
                                        "enum": [
                                            "default",
                                            "currency",
                                            "number",
                                            "percent"
                                        ],
                                        "description": "Format type"
                                    },
                                    "round": {
                                        "type": "number",
                                        "description": "Number of decimal places"
                                    },
                                    "currency": {
                                        "type": "string",
                                        "description": "Currency code (e.g., USD, GBP, EUR)"
                                    },
                                    "separator": {
                                        "type": "string",
                                        "enum": [
                                            "default",
                                            "commaPeriod",
                                            "spacePeriod",
                                            "periodComma",
                                            "spaceComma"
                                        ]
                                    },
                                    "suffix": {
                                        "type": "string",
                                        "description": "Suffix to append to formatted values"
                                    },
                                    "prefix": {
                                        "type": "string",
                                        "description": "Prefix to prepend to formatted values"
                                    },
                                    "compact": {
                                        "type": "string",
                                        "enum": [
                                            "thousands",
                                            "millions",
                                            "billions",
                                            "trillions",
                                            "kilobytes",
                                            "megabytes",
                                            "gigabytes",
                                            "terabytes",
                                            "petabytes",
                                            "kibibytes",
                                            "mebibytes",
                                            "gibibytes",
                                            "tebibytes",
                                            "pebibytes"
                                        ],
                                        "description": "Compact format for large numbers (K, M, B, T) or byte units"
                                    }
                                }
                            },
                            "template": {
                                "type": "object",
                                "description": "Template-based calculation (alternative to sql)",
                                "additionalProperties": false,
                                "required": ["type"],
                                "properties": {
                                    "type": {
                                        "type": "string",
                                        "enum": [
                                            "percent_change_from_previous",
                                            "percent_of_previous_value",
                                            "percent_of_column_total",
                                            "rank_in_column",
                                            "running_total",
                                            "window_function"
                                        ],
                                        "description": "Type of template calculation"
                                    },
                                    "fieldId": {
                                        "type": ["string", "null"],
                                        "description": "Field ID to apply the template to"
                                    },
                                    "orderBy": {
                                        "type": "array",
                                        "description": "Fields to order by for window functions",
                                        "items": {
                                            "type": "object",
                                            "additionalProperties": false,
                                            "required": ["fieldId"],
                                            "properties": {
                                                "fieldId": {
                                                    "type": "string",
                                                    "description": "Field ID to order by"
                                                },
                                                "order": {
                                                    "type": ["string", "null"],
                                                    "enum": [
                                                        "asc",
                                                        "desc",
                                                        null
                                                    ],
                                                    "description": "Sort direction"
                                                }
                                            }
                                        }
                                    },
                                    "partitionBy": {
                                        "type": "array",
                                        "description": "Fields to partition by for window functions",
                                        "items": {
                                            "type": "string"
                                        }
                                    },
                                    "windowFunction": {
                                        "type": "string",
                                        "description": "Window function type (for window_function template)"
                                    },
                                    "frame": {
                                        "type": "object",
                                        "description": "Frame clause for window functions",
                                        "additionalProperties": false,
                                        "properties": {
                                            "frameType": {
                                                "type": "string",
                                                "description": "Type of frame (ROWS or RANGE)"
                                            },
                                            "start": {
                                                "type": "object",
                                                "description": "Start boundary of the frame",
                                                "additionalProperties": false,
                                                "properties": {
                                                    "type": {
                                                        "type": "string",
                                                        "description": "Boundary type"
                                                    },
                                                    "offset": {
                                                        "type": "number",
                                                        "description": "Offset for PRECEDING/FOLLOWING"
                                                    }
                                                }
                                            },
                                            "end": {
                                                "type": "object",
                                                "description": "End boundary of the frame",
                                                "additionalProperties": false,
                                                "required": ["type"],
                                                "properties": {
                                                    "type": {
                                                        "type": "string",
                                                        "description": "Boundary type"
                                                    },
                                                    "offset": {
                                                        "type": "number",
                                                        "description": "Offset for PRECEDING/FOLLOWING"
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                },
                "additionalMetrics": {
                    "type": "array",
                    "description": "Custom metrics defined inline (ad-hoc metrics not in the dbt model)",
                    "items": {
                        "type": "object",
                        "additionalProperties": false,
                        "required": ["name", "label", "sql", "table", "type"],
                        "properties": {
                            "name": {
                                "type": "string",
                                "description": "Internal name of the metric"
                            },
                            "label": {
                                "type": "string",
                                "description": "Display label for the metric"
                            },
                            "description": {
                                "type": "string",
                                "description": "Description of what the metric measures"
                            },
                            "sql": {
                                "type": "string",
                                "description": "SQL expression (e.g., ${TABLE}.column_name)"
                            },
                            "table": {
                                "type": "string",
                                "description": "Table name the metric belongs to"
                            },
                            "type": {
                                "type": "string",
                                "enum": [
                                    "count",
                                    "count_distinct",
                                    "sum",
                                    "average",
                                    "min",
                                    "max"
                                ],
                                "description": "Aggregation type"
                            },
                            "baseDimensionName": {
                                "type": "string",
                                "description": "Name of the base dimension/column this metric aggregates"
                            },
                            "uuid": {
                                "type": ["string", "null"],
                                "description": "Unique identifier for the metric (readonly)"
                            },
                            "hidden": {
                                "type": "boolean",
                                "description": "Whether the metric is hidden from users"
                            },
                            "percentile": {
                                "type": "number",
                                "description": "Percentile value for percentile metrics"
                            },
                            "index": {
                                "type": "number",
                                "description": "Display order index"
                            },
                            "filters": {
                                "type": "array",
                                "description": "Filters to apply to this metric",
                                "items": {
                                    "type": "object",
                                    "additionalProperties": false,
                                    "required": ["target", "operator"],
                                    "properties": {
                                        "id": {
                                            "type": "string",
                                            "description": "Optional unique identifier for the filter"
                                        },
                                        "target": {
                                            "type": "object",
                                            "additionalProperties": false,
                                            "required": ["fieldRef"],
                                            "properties": {
                                                "fieldRef": {
                                                    "type": "string",
                                                    "description": "Field reference to filter on (e.g., 'table_name.field_name')"
                                                }
                                            }
                                        },
                                        "operator": {
                                            "type": "string",
                                            "description": "Filter operator",
                                            "enum": [
                                                "equals",
                                                "notEquals",
                                                "isNull",
                                                "notNull",
                                                "startsWith",
                                                "endsWith",
                                                "include",
                                                "doesNotInclude",
                                                "lessThan",
                                                "lessThanOrEqual",
                                                "greaterThan",
                                                "greaterThanOrEqual",
                                                "inThePast",
                                                "notInThePast",
                                                "inTheNext",
                                                "inTheCurrent",
                                                "notInTheCurrent",
                                                "inBetween",
                                                "notInBetween"
                                            ]
                                        },
                                        "values": {
                                            "type": "array",
                                            "description": "Values to filter by"
                                        },
                                        "settings": {
                                            "type": "object",
                                            "description": "Additional settings for date/time filters",
                                            "additionalProperties": false,
                                            "properties": {
                                                "unitOfTime": {
                                                    "type": "string",
                                                    "enum": [
                                                        "milliseconds",
                                                        "seconds",
                                                        "minutes",
                                                        "hours",
                                                        "days",
                                                        "weeks",
                                                        "months",
                                                        "quarters",
                                                        "years"
                                                    ],
                                                    "description": "Time unit for relative date filters"
                                                },
                                                "completed": {
                                                    "type": "boolean",
                                                    "description": "For date filters, whether to include completed periods"
                                                }
                                            }
                                        }
                                    }
                                }
                            },
                            "formatOptions": {
                                "type": "object",
                                "description": "Formatting configuration",
                                "additionalProperties": false,
                                "properties": {
                                    "type": {
                                        "type": "string",
                                        "enum": [
                                            "default",
                                            "currency",
                                            "number",
                                            "percent"
                                        ]
                                    },
                                    "round": {
                                        "type": "number",
                                        "description": "Number of decimal places"
                                    },
                                    "currency": {
                                        "type": "string",
                                        "description": "Currency code (e.g., USD, GBP, EUR)"
                                    },
                                    "separator": {
                                        "type": "string",
                                        "enum": [
                                            "default",
                                            "commaPeriod",
                                            "spacePeriod",
                                            "periodComma",
                                            "spaceComma"
                                        ]
                                    },
                                    "suffix": {
                                        "type": "string",
                                        "description": "Suffix to append to formatted values"
                                    },
                                    "prefix": {
                                        "type": "string",
                                        "description": "Prefix to prepend to formatted values"
                                    },
                                    "compact": {
                                        "type": "string",
                                        "enum": [
                                            "thousands",
                                            "millions",
                                            "billions",
                                            "trillions",
                                            "kilobytes",
                                            "megabytes",
                                            "gigabytes",
                                            "terabytes",
                                            "petabytes",
                                            "kibibytes",
                                            "mebibytes",
                                            "gibibytes",
                                            "tebibytes",
                                            "pebibytes"
                                        ],
                                        "description": "Compact format for large numbers (K, M, B, T) or byte units"
                                    }
                                }
                            }
                        }
                    }
                },
                "customDimensions": {
                    "type": "array",
                    "description": "Custom dimensions defined inline",
                    "items": {
                        "type": "object"
                    }
                }
            }
        },
        "chartConfig": {
            "type": "object",
            "description": "Visualization configuration for the chart",
            "additionalProperties": false,
            "required": ["type"],
            "properties": {
                "type": {
                    "type": "string",
                    "description": "Type of chart visualization",
                    "enum": [
                        "cartesian",
                        "pie",
                        "table",
                        "big_number",
                        "funnel",
                        "treemap",
                        "custom"
                    ]
                },
                "config": {
                    "type": ["object", "null"],
                    "description": "Chart-specific configuration (varies by chart type)"
                }
            }
        },
        "tableConfig": {
            "type": "object",
            "description": "Table view configuration",
            "additionalProperties": false,
            "properties": {
                "columnOrder": {
                    "type": "array",
                    "description": "Order of columns in table view",
                    "items": {
                        "type": "string"
                    }
                }
            }
        },
        "pivotConfig": {
            "type": "object",
            "description": "Pivot table configuration",
            "additionalProperties": false,
            "properties": {
                "columns": {
                    "type": "array",
                    "description": "Fields to use as pivot columns",
                    "items": {
                        "type": "string"
                    }
                }
            }
        }
    }
}
