name: Cache Cleanup

on:
  schedule:
    - cron: '0 3 * * *' # Daily at 3am UTC
  workflow_dispatch: # Allow manual trigger

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Cleanup old caches if above 9GB
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "Fetching cache usage..."
          TOTAL_SIZE=$(gh cache list --repo "$REPO" --json sizeInBytes --jq '[.[].sizeInBytes] | add // 0')
          TOTAL_GB=$(echo "scale=2; $TOTAL_SIZE / 1000000000" | bc)
          echo "Current cache size: ${TOTAL_GB}GB"

          THRESHOLD=9000000000  # 9GB
          TARGET=6000000000     # Delete down to ~6GB (removing ~3GB)

          if [ "$(echo "$TOTAL_SIZE < $THRESHOLD" | bc)" -eq 1 ]; then
            echo "Cache size is below 9GB threshold, no cleanup needed."
            exit 0
          fi

          echo "Cache exceeds 9GB, deleting oldest caches to free ~3GB..."
          BYTES_TO_DELETE=$((TOTAL_SIZE - TARGET))
          DELETED=0

          # Write caches to a temp file to avoid subshell issues with pipes
          gh cache list --repo "$REPO" --sort last_accessed_at --order asc --limit 200 --json id,key,sizeInBytes,lastAccessedAt > /tmp/caches.json

          CACHE_COUNT=$(jq length /tmp/caches.json)
          for i in $(seq 0 $((CACHE_COUNT - 1))); do
            if [ "$DELETED" -ge "$BYTES_TO_DELETE" ]; then
              break
            fi

            CACHE_ID=$(jq -r ".[$i].id" /tmp/caches.json)
            CACHE_KEY=$(jq -r ".[$i].key" /tmp/caches.json)
            CACHE_SIZE=$(jq -r ".[$i].sizeInBytes" /tmp/caches.json)
            CACHE_ACCESSED=$(jq -r ".[$i].lastAccessedAt" /tmp/caches.json)

            SIZE_MB=$(echo "scale=1; $CACHE_SIZE / 1000000" | bc)
            echo "Deleting: $CACHE_KEY (${SIZE_MB}MB, last accessed: $CACHE_ACCESSED)"
            gh cache delete "$CACHE_ID" --repo "$REPO" || true
            DELETED=$((DELETED + CACHE_SIZE))
          done

          DELETED_GB=$(echo "scale=2; $DELETED / 1000000000" | bc)
          echo "Deleted ${DELETED_GB}GB of cache."

          NEW_SIZE=$(gh cache list --repo "$REPO" --json sizeInBytes --jq '[.[].sizeInBytes] | add // 0')
          NEW_GB=$(echo "scale=2; $NEW_SIZE / 1000000000" | bc)
          echo "New cache size: ${NEW_GB}GB"
