name: Cache Cleanup

on:
  schedule:
    - cron: '0 3 * * *' # Daily at 3am UTC
  workflow_dispatch: # Allow manual trigger

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Cleanup old caches if above 9GB
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "Fetching cache usage..."
          TOTAL_SIZE=$(gh api repos/$REPO/actions/cache/usage --jq '.active_caches_size_in_bytes')
          TOTAL_GB=$(echo "scale=2; $TOTAL_SIZE / 1000000000" | bc)
          echo "Current cache size: ${TOTAL_GB}GB"

          THRESHOLD=9000000000  # 9GB
          TARGET=6000000000     # Delete down to ~6GB (removing ~3GB)

          if [ "$(echo "$TOTAL_SIZE < $THRESHOLD" | bc)" -eq 1 ]; then
            echo "Cache size is below 9GB threshold, no cleanup needed."
            exit 0
          fi

          echo "Cache exceeds 9GB, deleting oldest caches to free ~3GB..."
          BYTES_TO_DELETE=$((TOTAL_SIZE - TARGET))
          DELETED=0

          # Use the REST API to list caches across all branches, sorted by last accessed (oldest first)
          PAGE=1
          while [ "$DELETED" -lt "$BYTES_TO_DELETE" ]; do
            gh api "repos/$REPO/actions/caches?per_page=100&page=$PAGE&sort=last_accessed_at&direction=asc" > /tmp/caches.json

            CACHE_COUNT=$(jq '.actions_caches | length' /tmp/caches.json)
            if [ "$CACHE_COUNT" -eq 0 ]; then
              echo "No more caches to delete."
              break
            fi

            for i in $(seq 0 $((CACHE_COUNT - 1))); do
              if [ "$DELETED" -ge "$BYTES_TO_DELETE" ]; then
                break
              fi

              CACHE_ID=$(jq -r ".actions_caches[$i].id" /tmp/caches.json)
              CACHE_KEY=$(jq -r ".actions_caches[$i].key" /tmp/caches.json)
              CACHE_SIZE=$(jq -r ".actions_caches[$i].size_in_bytes" /tmp/caches.json)
              CACHE_ACCESSED=$(jq -r ".actions_caches[$i].last_accessed_at" /tmp/caches.json)
              CACHE_REF=$(jq -r ".actions_caches[$i].ref" /tmp/caches.json)

              SIZE_MB=$(echo "scale=1; $CACHE_SIZE / 1000000" | bc)
              echo "Deleting: $CACHE_KEY (${SIZE_MB}MB, ref: $CACHE_REF, last accessed: $CACHE_ACCESSED)"
              gh api --method DELETE "repos/$REPO/actions/caches/$CACHE_ID" || true
              DELETED=$((DELETED + CACHE_SIZE))
            done

            PAGE=$((PAGE + 1))
          done

          DELETED_GB=$(echo "scale=2; $DELETED / 1000000000" | bc)
          echo "Deleted ${DELETED_GB}GB of cache."

          NEW_SIZE=$(gh api repos/$REPO/actions/cache/usage --jq '.active_caches_size_in_bytes')
          NEW_GB=$(echo "scale=2; $NEW_SIZE / 1000000000" | bc)
          echo "New cache size: ${NEW_GB}GB"
