# Dependabot Alert #382: node-forge ASN.1 Unbounded Recursion

## Summary

| Field | Value |
|-------|-------|
| **Package** | node-forge |
| **Current Version** | 1.3.1 |
| **Vulnerable Range** | < 1.3.2 |
| **Patched Version** | 1.3.2 |
| **CVE** | CVE-2025-66031 |

## Is This Repo Affected?

**Yes**, the repository is affected.

The vulnerable version of node-forge (1.3.1) is installed as a transitive dependency through the following chain:

```
backend (packages/backend)
  └── googleapis@105.0.0
      ├── google-auth-library@8.9.0
      │   └── gtoken@6.1.2
      │       └── google-p12-pem@4.0.1
      │           └── node-forge@1.3.1
      └── googleapis-common@6.0.4
          └── google-auth-library@8.9.0
              └── ... (same chain)

cli (packages/cli)
  └── google-auth-library@8.9.0
      └── gtoken@6.1.2
          └── google-p12-pem@4.0.1
              └── node-forge@1.3.1
```

## Vulnerability Details

The vulnerability is an ASN.1 unbounded recursion issue that allows attackers to craft deeply nested ASN.1 structures, causing denial-of-service through stack exhaustion. Version 1.3.2 addresses this by implementing a configurable global maximum recursion depth of 256.

The vulnerability affects:
- P12/PKCS12 certificate parsing
- ASN.1 structure parsing operations

Since this repository uses `google-p12-pem` (which uses node-forge for PKCS12 operations) in the Google authentication flow, there is potential exposure when processing P12 certificate files from untrusted sources.

**Risk Assessment**: Moderate - The primary use case appears to be for Google Cloud authentication where P12 files are typically from trusted sources (Google). However, if users can upload arbitrary P12 files, there is a DoS risk.

## Recommended Upgrade Action

### Option 1: pnpm Override (Recommended)

Add a pnpm override to the root `package.json` to force the patched version:

```json
{
  "pnpm": {
    "overrides": {
      "node-forge": "^1.3.2"
    }
  }
}
```

This works because `google-p12-pem@4.0.1` specifies `"node-forge": "^1.3.1"` which is compatible with 1.3.2.

### Option 2: Wait for Upstream

Monitor for updates to the dependency chain. However, this is not recommended as the security fix is straightforward and compatible.

## Breaking Changes

### From 1.3.1 to 1.3.2

The update from 1.3.1 to 1.3.2 is a **patch release** with no breaking changes. The only changes are security fixes:

1. **ASN.1 Unbounded Recursion (CVE-2025-66031)**: Adds configurable maximum recursion depth (default: 256)
2. **ASN.1 Validator Desynchronization (CVE-2025-12816)**: Fixes schema validation bypass
3. **ASN.1 OID Integer Truncation (CVE-2025-66030)**: Prevents OID arc truncation

**Potential Edge Case**: If your use case legitimately requires ASN.1 structures deeper than 256 levels (highly unlikely in normal certificate/cryptographic operations), you may need to configure `asn1.maxDepth` to a higher value.

## Steps to Perform the Upgrade

1. **Edit the root package.json**:
   ```bash
   # In /Users/oliverlaslett/code/lightdash/package.json
   # Add to the pnpm.overrides section:
   "node-forge": "^1.3.2"
   ```

2. **Update lockfile and install**:
   ```bash
   pnpm install
   ```

3. **Verify the upgrade**:
   ```bash
   pnpm why node-forge
   # Should show 1.3.2 instead of 1.3.1
   ```

4. **Run tests to ensure no regressions**:
   ```bash
   pnpm -F backend test
   pnpm -F cli test
   ```

5. **Test Google BigQuery authentication** (if applicable):
   - Ensure that BigQuery warehouse connections using service account P12 files still work correctly

## Additional Notes

- The latest version of node-forge is 1.3.3, but 1.3.2 is sufficient to patch this specific vulnerability
- Consider upgrading to 1.3.3 to get all latest patches
- The `google-auth-library` ecosystem is actively maintained, so upstream updates should eventually resolve this without overrides
