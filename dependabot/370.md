# Dependabot Alert #370: vega-interpreter XSS Vulnerability

## Summary

| Field | Value |
|-------|-------|
| **Package** | `vega-interpreter` |
| **Current Version** | 1.0.5 |
| **Vulnerable Range** | < 1.2.1 |
| **Patched Version** | 1.2.1 (v1-maintenance branch) or 2.2.1 (latest) |
| **CVE** | CVE-2025-59840 |
| **Advisory** | [GHSA-7f2v-3qq3-vvjf](https://github.com/vega/vega/security/advisories/GHSA-7f2v-3qq3-vvjf) |

## Dependency Chain

```
@lightdash/frontend
  -> react-vega@7.6.0
     -> vega-embed@6.23.0
        -> vega-interpreter@1.0.5 (VULNERABLE)
```

## Is This Repo Affected?

**Likely LOW risk, but should still be patched.**

The vulnerability requires TWO conditions to be exploitable:

1. **Global Exposure**: The application attaches Vega library and View instances to the global `window` object
2. **Untrusted Input**: User-defined Vega JSON definitions are allowed

**Analysis of Lightdash:**

- **Untrusted Input**: YES - Lightdash accepts user-defined Vega-Lite JSON specs for custom visualizations (see `/packages/frontend/src/components/CustomVisualization/index.tsx`)
- **Global Exposure**: NO - The codebase does not appear to attach Vega to `window` or `globalThis`
- **VEGA_DEBUG**: Not found in codebase

While Lightdash doesn't appear to meet condition #1, the advisory notes that "in cases where VEGA_DEBUG is not enabled, there theoretically could be other gadgets on the global scope that allow for similar behavior." Given that the fix is straightforward and low-risk, patching is recommended.

## Recommended Upgrade Action

**Option A (Recommended): Use pnpm override to force patched version**

Add to `package.json` in the `pnpm.overrides` section:

```json
{
  "pnpm": {
    "overrides": {
      "vega-interpreter": "1.2.1"
    }
  }
}
```

This forces the patched v1.2.1 (v1-maintenance branch) which is compatible with the current vega-embed 6.23.0.

**Option B: Upgrade vega-embed to v7.x**

This would involve upgrading the full Vega stack:
- `react-vega`: 7.6.0 -> 8.0.0
- `vega-embed`: 6.23.0 -> 7.1.0 (bundled via react-vega)
- `vega-interpreter`: would use 2.x automatically

**Not recommended** due to breaking changes in vega-embed 7.x:
1. ESM-only package (no CommonJS support)
2. Default renderer changed from Canvas to SVG
3. Major version bumps in related dependencies (vega-themes, vega-tooltip)

## Risks and Breaking Changes

### Option A Risks (Override to 1.2.1)

- **Very Low Risk**: The v1-maintenance branch (1.2.1) maintains API compatibility with 1.0.5
- vega-interpreter 1.2.1 depends on `vega-util@^1.17.4` (same major version as before)
- This is a security-only patch with no functional changes

### Option B Risks (Upgrade to vega-embed 7.x)

1. **ESM-Only**: Build configuration may need updates
2. **SVG Default Renderer**: Visual output may differ; canvas rendering must be explicitly configured
3. **Testing Required**: Custom visualizations should be thoroughly tested

## Steps to Perform the Upgrade

### Option A (Recommended)

1. Edit `/Users/oliverlaslett/code/lightdash/package.json`
2. Add to the `pnpm.overrides` section:
   ```json
   "vega-interpreter": "1.2.1"
   ```
3. Run `pnpm install`
4. Verify the version: `pnpm why vega-interpreter`
5. Test custom visualizations in the frontend

### Option B (Full Upgrade)

1. Update frontend dependencies:
   ```bash
   pnpm -F frontend add react-vega@8.0.0
   ```
2. Update imports if needed (check for any direct vega-embed imports)
3. Test all custom visualization functionality
4. Verify renderer behavior (may need to explicitly set canvas renderer)
5. Update any build configuration for ESM compatibility

## Verification

After applying the fix, verify with:

```bash
pnpm why vega-interpreter
# Should show version 1.2.1 or higher

# Also verify the lockfile
grep "vega-interpreter" pnpm-lock.yaml
```

## References

- [GitHub Advisory GHSA-7f2v-3qq3-vvjf](https://github.com/vega/vega/security/advisories/GHSA-7f2v-3qq3-vvjf)
- [NPM vega-interpreter](https://www.npmjs.com/package/vega-interpreter)
- [vega-embed releases](https://github.com/vega/vega-embed/releases)
