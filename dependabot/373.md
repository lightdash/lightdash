# Dependabot Alert #373: vega XSS Vulnerability

## Package Information

- **Package**: vega
- **Current Version**: 5.32.0 (installed as peer dependency of react-vega and vega-lite)
- **Vulnerable Range**: < 6.2.0
- **Patched Version**: 6.2.0
- **CVE**: CVE-2025-59840
- **Severity**: High (XSS vulnerability)

## Vulnerability Details

**Title**: Vega Cross-Site Scripting (XSS) via expressions abusing toString calls in environments using the VEGA_DEBUG global variable

**Description**: The vulnerability allows DOM XSS through crafted objects that override their toString method with a function that results in calling `this.foo(this.bar)`. In practice, an accessible gadget exists in the global `VEGA_DEBUG` code. The vulnerability requires user interaction with the page to trigger.

**Impact**: Allows execution of arbitrary JavaScript in the context of the application's domain, potentially leading to theft of authentication tokens, manipulation of displayed data, or unauthorized actions.

## Is This Repo Affected?

**Partially mitigated, but still at risk.**

### Current State

1. **vega-expression**: Currently at `5.2.1` which is the **patched version** for the 5.x line
2. **vega-interpreter**: Currently at `1.0.5` which is **NOT patched** (patched version is `1.2.1`)
3. **VEGA_DEBUG**: Not explicitly set in the codebase (searched and found no usage)
4. **Global window attachment**: Not found in the codebase

### Risk Assessment

- **Low-Medium Risk**: The main attack vector (VEGA_DEBUG) is not enabled in the codebase
- **vega-expression is patched**: The critical `vega-expression@5.2.1` is already installed
- **vega-interpreter is vulnerable**: However, this is only a concern when using AST evaluator mode
- **Custom Vega-Lite specs**: Users can provide custom Vega-Lite JSON specifications, which could theoretically contain malicious expressions if other gadgets exist

### Usage in Lightdash

Vega is used in the Custom Visualization feature:
- `/packages/frontend/src/components/CustomVisualization/index.tsx` - Renders VegaLite charts
- `/packages/frontend/src/components/VisualizationConfigs/ChartConfigPanel/CustomVis/CustomVisConfig.tsx` - Editor for Vega-Lite JSON specs

Users can input arbitrary Vega-Lite JSON, which is a potential attack surface if other global gadgets are discovered.

## Dependency Chain

```
react-vega@7.6.0
├── vega@5.32.0 (peer)
│   └── vega-expression@5.2.1 (PATCHED)
└── vega-embed@6.23.0
    ├── vega@5.32.0 (peer)
    └── vega-interpreter@1.0.5 (VULNERABLE - needs 1.2.1)

vega-lite@5.16.1
└── vega@5.32.0 (peer)
```

## Recommended Upgrade Action

### Option 1: Minimal Update (Recommended)

Update to the latest vega 5.x line to get the patched vega-interpreter while maintaining compatibility:

```bash
# In packages/frontend/package.json, add an explicit resolution
pnpm add vega@5.33.0 -F frontend
```

Then add a pnpm override in the root `package.json`:
```json
{
  "pnpm": {
    "overrides": {
      "vega-interpreter": "^1.2.1"
    }
  }
}
```

This ensures `vega-interpreter@1.2.1` is used, which is the patched version for the 1.x line.

### Option 2: Full Upgrade (Breaking Changes)

Upgrade the entire vega ecosystem to v6:

| Package | Current | Target |
|---------|---------|--------|
| vega | 5.32.0 | 6.2.0 |
| vega-lite | 5.16.1 | 6.4.1 |
| react-vega | 7.6.0 | 8.0.0 |

**Note**: This requires coordinated updates and involves breaking changes.

## Breaking Changes (Option 2)

### vega 5.x to 6.x
- Major version upgrade with potential API changes
- Expression evaluation changes for security hardening
- May require updates to existing Vega specifications

### vega-lite 5.x to 6.x
- Requires vega ^6.0.0 as peer dependency
- Potential spec format changes

### react-vega 7.x to 8.x
- Requires vega-embed ^7 as peer dependency
- React 17/18/19 support (compatible)

## Steps to Perform the Upgrade

### For Option 1 (Minimal - Recommended)

1. Add pnpm override to root `package.json`:
   ```json
   {
     "pnpm": {
       "overrides": {
         "vega-interpreter": "^1.2.1"
       }
     }
   }
   ```

2. Run `pnpm install` to update the lockfile

3. Verify the fix:
   ```bash
   pnpm -F frontend why vega-interpreter
   # Should show 1.2.1
   ```

4. Test the Custom Visualization feature manually

### For Option 2 (Full Upgrade)

1. Update `packages/frontend/package.json`:
   ```json
   {
     "dependencies": {
       "react-vega": "^8.0.0",
       "vega-lite": "^6.4.1"
     }
   }
   ```

2. Run `pnpm install`

3. Check for TypeScript errors:
   ```bash
   pnpm -F frontend typecheck
   ```

4. Review and update any Vega-Lite spec templates in:
   - `/packages/frontend/src/components/VisualizationConfigs/ChartConfigPanel/CustomVis/utils/vegaTemplates.tsx`

5. Test thoroughly:
   - Custom visualization creation
   - All template charts
   - Chart rendering with various data types

## Risks and Considerations

### Option 1 Risks (Low)
- Minimal change, only updates vega-interpreter
- No API changes expected
- Should be safe to deploy

### Option 2 Risks (Medium-High)
- Major version upgrades across multiple packages
- Vega-Lite spec format may have changed
- Custom visualizations created by users may break
- Requires comprehensive testing of all chart types
- May require updating documentation and examples

## Recommendation

**Proceed with Option 1** (pnpm override for vega-interpreter) as it:
1. Resolves the remaining vulnerability (vega-interpreter)
2. Does not require major version upgrades
3. Minimizes risk of breaking changes
4. Can be deployed quickly

The existing `vega-expression@5.2.1` is already patched, so the main remaining vulnerability is in `vega-interpreter@1.0.5`. The VEGA_DEBUG attack vector is not present in this codebase, further reducing risk.

## References

- [GitHub Security Advisory GHSA-7f2v-3qq3-vvjf](https://github.com/vega/vega/security/advisories/GHSA-7f2v-3qq3-vvjf)
- [CVE-2025-59840](https://github.com/advisories/GHSA-7f2v-3qq3-vvjf)
- [Vega GitHub Repository](https://github.com/vega/vega)
- [Vega-Lite Releases](https://github.com/vega/vega-lite/releases)
