# Dependabot Alert #393: jws HMAC Signature Verification Vulnerability

## Summary

| Field | Value |
|-------|-------|
| Package | `jws` |
| Current Version | `3.2.2` (transitive via `jsonwebtoken@9.0.2`) |
| Vulnerable Range | `< 3.2.3` |
| Patched Version | `3.2.3` or `4.0.1` |
| Severity | High (CVSS 7.5) |
| CVE | CVE-2025-65945 |
| Advisory | GHSA-869p-cjfg-cm3x |

## Dependency Chain

```
packages/backend
  └── jsonwebtoken@9.0.2
        └── jws@3.2.2 (VULNERABLE)
```

## Is This Repo Affected?

**No, this repository is NOT affected by this vulnerability.**

### Why Not Affected

The vulnerability (GHSA-869p-cjfg-cm3x) specifically affects applications that:

1. Use `jws.createVerify()` directly for HMAC algorithms, AND
2. Incorporate user-controlled JWT data into secret selection logic

Applications using the `jws.verify()` interface (which includes all users of `auth0/node-jsonwebtoken`) or asymmetric algorithms like RS256 are **unaffected**.

### Usage Analysis

This repository uses `jsonwebtoken` in two locations:

1. **`/packages/backend/src/auth/lightdashJwt.ts`**
   - Uses `verify(token, secret)` and `sign(jwtData, secret, options)` from jsonwebtoken
   - Does NOT use `jws.createVerify()` directly
   - Secret is derived from encrypted configuration, not from JWT data

2. **`/packages/backend/src/ee/services/AiAgentAdminService.ts`**
   - Uses `jwt.sign(data, secret, options)` for token creation only
   - Does NOT perform verification using jws directly

Both usages go through `jsonwebtoken`'s `verify()` interface, which is explicitly noted as **not affected** in the security advisory.

## Recommended Upgrade Action

**Upgrade `jsonwebtoken` from `9.0.2` to `9.0.3`**

Even though this repository is not affected, upgrading is recommended to:
- Clear the Dependabot alert
- Stay current with security patches
- Avoid false positives in security scans

The latest `jsonwebtoken@9.0.3` depends on `jws@^4.0.1`, which is patched.

## Breaking Changes

**None.** Version 9.0.3 is a patch release that only updates the `jws` dependency from `^3.2.2` to `^4.0.1`. There are no API changes or breaking changes.

For reference, the last breaking changes were in v9.0.0 (2022-12-21), which this repository already uses.

## Upgrade Steps

1. Update the dependency in `/packages/backend/package.json`:
   ```bash
   cd packages/backend
   pnpm update jsonwebtoken@9.0.3
   ```

2. Regenerate the lockfile:
   ```bash
   pnpm install
   ```

3. Verify the vulnerable version is removed:
   ```bash
   grep "jws@3.2.2" pnpm-lock.yaml
   # Should return no results
   ```

4. Run tests to confirm no regressions:
   ```bash
   pnpm -F backend test:dev:nowatch
   ```

5. Verify JWT functionality works (optional manual test):
   - Test embedded dashboard authentication
   - Test AI agent analytics embed token generation

## Risks

**Low risk upgrade:**
- No API changes between 9.0.2 and 9.0.3
- The vulnerable code path was never used by this application
- jws 4.x is a major version bump but jsonwebtoken abstracts this

## Additional Notes

- The `jws@4.0.0` version is also present in the lockfile (used by Google Auth libraries like `gtoken`), but this version is also unaffected by the specific vulnerability as it only impacts the `createVerify()` interface
- Both `jws@3.2.3` (patched 3.x) and `jws@4.0.1` (patched 4.x) address this vulnerability
