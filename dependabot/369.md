# Dependabot Alert #369: vega-expression XSS Vulnerability

## Package Information

- **Package**: vega-expression
- **Vulnerable Version**: 5.1.0 (installed via vega-lite@5.16.1)
- **Patched Version**: 5.2.1
- **CVE**: CVE-2025-59840
- **Severity**: High (CVSS 3.1: AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:N)

## Vulnerability Summary

Cross-Site Scripting (XSS) via expressions abusing toString calls in environments using the VEGA_DEBUG global variable. An attacker can craft a malicious Vega specification that, when processed, can execute arbitrary JavaScript in the context of the application's domain.

## Current State in Lightdash

### Installed Versions

Both vulnerable and patched versions are present in the lockfile:
- `vega-expression@5.1.0` - **VULNERABLE** (via vega-lite@5.16.1)
- `vega-expression@5.2.1` - patched (via vega@5.32.0, vega-functions, vega-selections, etc.)

### Dependency Chain

```
react-vega@7.6.0
  -> vega@5.32.0 (peer) -> vega-expression@5.2.1 (patched)
  -> vega-embed@6.23.0 -> vega@5.32.0 -> vega-expression@5.2.1 (patched)

vega-lite@5.16.1
  -> vega-expression@5.1.0 (VULNERABLE)
```

### Usage in Codebase

Vega is used in the frontend for custom visualizations:
- `/packages/frontend/src/components/CustomVisualization/index.tsx`
- Uses `VegaLite` component from react-vega
- Users can input custom Vega-Lite JSON specifications

## Is This Repo Affected?

**Likely Yes, but with mitigations:**

### Risk Factors

1. **User-supplied Vega specs**: The CustomVisualization component allows users to input arbitrary Vega-Lite JSON, which is then rendered. This is the primary attack vector.

2. **Vulnerable dependency present**: vega-lite@5.16.1 pulls in vega-expression@5.1.0.

### Mitigating Factors

1. **VEGA_DEBUG not enabled**: The codebase does not set or use `VEGA_DEBUG`. The primary exploit chain relies on this global variable being accessible.

2. **User interaction required**: The vulnerability requires a user to interact with a malicious Vega specification.

3. **Authentication required**: Creating/editing custom visualizations likely requires authentication to Lightdash.

4. **Mixed versions**: While vega-lite uses the vulnerable version, vega@5.32.0 (from react-vega) uses the patched version. The actual vulnerability depends on which code path processes expressions.

## Recommended Upgrade Action

### Option 1: Use pnpm override (Recommended - Quick Fix)

Add a pnpm override to force vega-expression to the patched version:

```json
// In root package.json under pnpm.overrides
{
  "pnpm": {
    "overrides": {
      "vega-expression": "5.2.1"
    }
  }
}
```

**Pros**: Minimal risk, forces patched version for all consumers
**Cons**: May cause subtle issues if vega-lite relies on 5.1.0 specific behavior

### Option 2: Upgrade vega-lite (Breaking Changes)

Upgrade to vega-lite v6.x which uses vega-expression 6.1.0:

```json
// In packages/frontend/package.json
{
  "dependencies": {
    "vega-lite": "^6.4.1"
  }
}
```

**Breaking Changes in vega-lite 6.0:**
- ESM-only package (no CommonJS support)
- Default continuous size behavior changed
- Requires vega 6.x (react-vega@7.7.x bundles vega-embed 6.5.1 with vega 6 support)
- vega-event-selector upgraded from 3.x to 4.x

**Pros**: Complete fix, latest features
**Cons**: Significant breaking changes, may require code changes

### Option 3: Upgrade react-vega + vega-lite (Comprehensive)

```json
// In packages/frontend/package.json
{
  "dependencies": {
    "react-vega": "^7.7.1",
    "vega-lite": "^6.4.1"
  }
}
```

**Pros**: React 19 support, all latest versions
**Cons**: Same breaking changes as Option 2

## Risks and Breaking Changes

### pnpm Override (Option 1)

- Low risk: vega-expression 5.2.1 is a security patch release
- Changes are related to security hardening, not API changes
- Should be safe for vega-lite 5.16.1

### vega-lite 6.x Upgrade (Options 2 & 3)

1. **ESM-only**: Build configuration may need updates
2. **Default sizing**: Charts may render with different default sizes
3. **vega-event-selector 4.x**: Event handling API may have changed
4. **Testing required**: All custom visualizations should be tested

## Steps to Perform the Upgrade

### Option 1 (Recommended)

1. Edit `/Users/oliverlaslett/code/lightdash/package.json`:
   ```json
   "pnpm": {
     "overrides": {
       "vega-expression": "5.2.1",
       // ... existing overrides
     }
   }
   ```

2. Run `pnpm install`

3. Verify the fix:
   ```bash
   pnpm why vega-expression
   # Should show only 5.2.1
   ```

4. Test the CustomVisualization feature manually

### Option 2/3 (Full Upgrade)

1. Update dependencies in `packages/frontend/package.json`

2. Run `pnpm install`

3. Check for TypeScript errors: `pnpm -F frontend typecheck`

4. Check for ESM compatibility issues

5. Test all Vega-Lite visualizations

6. Review any default size changes in charts

## References

- [GitHub Security Advisory GHSA-7f2v-3qq3-vvjf](https://github.com/vega/vega/security/advisories/GHSA-7f2v-3qq3-vvjf)
- [CVE-2025-59840 Analysis](https://lab.ctbb.show/research/CVE-2025-59840-unusual-xss-technique-toString-gadget-chains)
- [vega-lite Releases](https://github.com/vega/vega-lite/releases)
