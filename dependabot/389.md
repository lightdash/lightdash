# Dependabot Alert #389: validator

## Summary

| Field | Value |
|-------|-------|
| Package | validator |
| Current Version | 13.12.0 |
| Patched Version | 13.15.22 |
| Vulnerability | CVE-2025-56200 - URL validation bypass in isURL() |
| Severity | Medium (CVSS 6.1) |
| Repo Affected | **Low risk** - not directly exploitable |

## Vulnerability Details

The `validator` package has a URL validation bypass vulnerability (CVE-2025-56200). The `isURL()` function uses `://` as a delimiter to parse protocols, while browsers use `:` as the delimiter. This parsing discrepancy allows attackers to craft malicious URLs that bypass protocol and domain validation, potentially leading to:
- Cross-site scripting (XSS)
- Open redirect attacks

## How validator Is Used in This Repo

The `validator` package is a **transitive dependency** brought in by `@tsoa/cli` and `@tsoa/runtime` (version 6.6.0) in `packages/backend/package.json`.

### Dependency Chain
```
backend
  -> @tsoa/cli@6.6.0
       -> validator@13.12.0
  -> @tsoa/runtime@6.6.0
       -> validator@13.12.0
```

### Usage Analysis

tsoa uses validator.js for:
1. **Date validation**: `isISO8601()` - validating date formats in metadata generation and runtime validation
2. **Integer validation**: `isInt()`, `toInt()` - validating integer inputs
3. **Float validation**: `isFloat()`, `toFloat()` - validating float inputs
4. **String matching**: `matches()`, `equals()` - pattern matching and enum validation

**Critical Finding**: tsoa does NOT use the vulnerable `isURL()` function. The vulnerability is specifically in URL validation, which tsoa does not utilize.

## Risk Assessment

**This repo is NOT directly affected by CVE-2025-56200** because:
1. The vulnerable function (`isURL()`) is not called by tsoa
2. Lightdash does not directly depend on or import the validator package
3. The validator functions used by tsoa (`isISO8601`, `isInt`, `isFloat`, `matches`, `equals`) are not affected by this vulnerability

However, upgrading is still recommended as a best practice to:
- Eliminate the security alert
- Get any other fixes in newer versions
- Stay current with dependencies

## Recommended Upgrade Action

### Option 1: Add pnpm Override (Quick Fix)

Add a pnpm override to force the patched version of validator:

```json
// In package.json under "pnpm.overrides"
{
  "pnpm": {
    "overrides": {
      "validator": "^13.15.22"
    }
  }
}
```

Then run:
```bash
pnpm install
```

### Option 2: Wait for tsoa Update (Recommended Long-term)

According to [tsoa releases](https://github.com/lukeautry/tsoa/releases):
- **v6.6.0** already includes a bump from validator 13.12.0 to 13.15.20
- **v7.0.0-alpha.0** updates validator to 13.15.22

The current pnpm-lock.yaml may have cached the old version. Steps:
1. Delete `pnpm-lock.yaml`
2. Run `pnpm install`
3. Verify validator version: `find node_modules -name validator -type d`

**Note**: v7.0.0 is currently in alpha. The stable v6.6.0 should resolve to 13.15.20+ with a fresh install.

## Breaking Changes

### validator 13.12.0 -> 13.15.22

Based on the [validator.js changelog](https://github.com/validatorjs/validator.js/releases), there are **no breaking changes** between these versions. Changes include:

**New Features (non-breaking):**
- New validators: `isISO31661Numeric`, `isULID`, `isISO15924`
- `isEmail`: Added `host_whitelist` option
- `isBtcAddress`: Extended to support all address formats
- `isUUID`: Improved variant field validation (added `loose` option for backwards compatibility)
- `isURL`: Added `max_allowed_length` option

**Bug Fixes:**
- `isURL`: Fixed protocol detection (the security fix)
- `isBase64`: Improved validation per RFC4648
- Various locale improvements

**Potential Minor Behavior Changes:**
- `isUUID`: Now requires valid variant field per RFC9562 (use `loose: true` for old behavior)
- This should not affect tsoa since it doesn't use `isUUID`

## Steps to Perform the Upgrade

1. **Edit `/Users/oliverlaslett/code/lightdash/package.json`**:
   ```diff
   "pnpm": {
     "overrides": {
       "hono": "^4.9.6",
       "linkifyjs": "^4.3.2",
       "axios": "^1.12.0",
       "form-data@2.5.3": "2.5.5",
       "form-data@3.0.1": "3.0.4",
       "form-data@4.0.0": "4.0.4",
   -   "form-data@4.0.2": "4.0.4"
   +   "form-data@4.0.2": "4.0.4",
   +   "validator": "^13.15.22"
     }
   }
   ```

2. **Update the lock file**:
   ```bash
   pnpm install
   ```

3. **Verify the fix**:
   ```bash
   # Check installed version
   cat node_modules/.pnpm/validator@*/node_modules/validator/package.json | grep version

   # Should show 13.15.22 or higher
   ```

4. **Run tests to ensure no regressions**:
   ```bash
   pnpm -F backend test:dev:nowatch
   pnpm generate-api  # Since tsoa uses validator
   ```

## References

- [CVE-2025-56200](https://nvd.nist.gov/vuln/detail/CVE-2025-56200)
- [GitHub Advisory GHSA-9965-vmph-33xx](https://github.com/advisories/GHSA-9965-vmph-33xx)
- [validator.js releases](https://github.com/validatorjs/validator.js/releases)
- [tsoa releases](https://github.com/lukeautry/tsoa/releases)
