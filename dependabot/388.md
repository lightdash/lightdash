# Dependabot Alert #388: @modelcontextprotocol/sdk DNS Rebinding Vulnerability

## Summary

| Field | Value |
|-------|-------|
| Package | `@modelcontextprotocol/sdk` |
| Current Version | `1.17.5` |
| Patched Version | `1.24.0` |
| Vulnerability | DNS rebinding protection not enabled by default |
| CVE | CVE-2025-66414 |
| GHSA | GHSA-w48q-cv73-mx4w |
| Severity | High (CVSS 7.6) |

## Is This Repo Affected?

**Likely NOT affected in production deployments.**

The vulnerability affects HTTP-based MCP servers running on **localhost without authentication**. Lightdash's MCP implementation:

1. **Uses authentication**: The MCP router at `/packages/backend/src/routers/mcpRouter.ts` requires authentication via:
   - `allowOauthAuthentication` middleware
   - `allowApiKeyAuthentication` middleware
   - `returnHeaderIfUnauthenticated` guard that returns 401 if not authenticated

2. **Uses `StreamableHTTPServerTransport`**: This transport is affected by the vulnerability, but only when running unauthenticated.

3. **Production deployments**: Lightdash typically runs behind proper domain names (not localhost) with authentication enabled.

**Risk scenarios:**
- Local development environments could be theoretically vulnerable if accessed via a malicious website while the dev server is running
- The risk is mitigated because authentication is still required to invoke MCP tools

## Recommended Upgrade Action

**Upgrade to version 1.24.0 or later.**

```bash
pnpm -F backend add @modelcontextprotocol/sdk@^1.24.0
```

## Breaking Changes Between 1.17.5 and 1.24.0

### 1. Type Changes (1.24.0)
- Removed loose/passthrough types not defined by MCP spec
- SDK now enforces stricter type compliance

### 2. TypeScript Target (1.24.0)
- Updated TypeScript target to ES2020 (AJV import fix)

### 3. Tool Naming Format (1.22.0 - SEP-986)
- New tool naming format conventions may apply

### 4. Elicitation Defaults (1.22.0 - SEP-1034)
- Changed default behaviors for elicitation

### 5. New Features (1.24.0)
- Tasks support
- Fetch transport
- SSE improvements (`closeSSEStream` callback, improved reconnection)
- URL elicitation support
- Client credentials flow for M2M auth
- Sampling with tools

## Steps to Perform the Upgrade

1. **Update the dependency:**
   ```bash
   pnpm -F backend add @modelcontextprotocol/sdk@^1.24.0
   ```

2. **Check for type errors:**
   ```bash
   pnpm -F backend typecheck
   ```

3. **Review MCP router for compatibility:**
   - File: `/packages/backend/src/routers/mcpRouter.ts`
   - File: `/packages/backend/src/ee/services/McpService/McpService.ts`
   - Look for any API changes in `StreamableHTTPServerTransport`, `McpServer`, or `AuthInfo`

4. **Consider adding explicit DNS rebinding protection:**
   After upgrading, optionally add the `hostHeaderValidation()` middleware to the MCP router for defense-in-depth, even though authentication is already required:
   ```typescript
   import { hostHeaderValidation } from '@modelcontextprotocol/sdk/server/middleware.js';
   // Add to router middleware stack
   ```

5. **Run tests:**
   ```bash
   pnpm -F backend test:dev:nowatch
   ```

6. **Test MCP functionality manually** if integration tests don't cover MCP endpoints.

## Risk Assessment

| Risk | Level | Notes |
|------|-------|-------|
| Breaking changes | Low-Medium | Type changes may require minor code updates |
| Security risk of not upgrading | Low | Authentication already mitigates the vulnerability |
| Regression risk | Low | MCP is a relatively isolated feature |

## References

- [GitHub Security Advisory GHSA-w48q-cv73-mx4w](https://github.com/modelcontextprotocol/typescript-sdk/security/advisories/GHSA-w48q-cv73-mx4w)
- [MCP TypeScript SDK Releases](https://github.com/modelcontextprotocol/typescript-sdk/releases)
- Package location: `/packages/backend/package.json` (line 60)
- MCP Router: `/packages/backend/src/routers/mcpRouter.ts`
- MCP Service: `/packages/backend/src/ee/services/McpService/McpService.ts`
