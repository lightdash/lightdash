/**
 * PM2 Ecosystem Configuration for Agent ${AGENT_ID}
 *
 * Auto-generated by launch.sh â€” do not edit manually.
 * Processes are prefixed with agent-${AGENT_ID}- for namespace isolation.
 */

const path = require('path');
const dotenv = require('dotenv');

// Load agent-specific env
const agentEnvPath = path.resolve(__dirname, '.env.agent.${AGENT_ID}');
const env = dotenv.config({ path: agentEnvPath }).parsed || {};

// Add venv/bin to PATH for dbt access
const venvBinPath = path.join(__dirname, 'venv', 'bin');
const envWithPath = {
    ...env,
    PATH: `${venvBinPath}:${process.env.PATH}`,
};

module.exports = {
    apps: [
        // Backend API Server
        {
            name: 'agent-${AGENT_ID}-api',
            script: 'src/index.ts',
            interpreter: 'node',
            node_args: '--import tsx --inspect=0.0.0.0:${DEBUG_PORT}',
            cwd: path.join(__dirname, 'packages/backend'),
            env: {
                ...envWithPath,
                LIGHTDASH_MODE: 'development',
                HEADLESS: 'true',
                NODE_ENV: 'development',
            },
            watch: false,
            autorestart: true,
            kill_timeout: 5000,
            merge_logs: true,
            time: true,
        },

        // Frontend Vite Dev Server
        {
            name: 'agent-${AGENT_ID}-frontend',
            script: 'node_modules/.bin/vite',
            args: '--port ${FE_PORT}',
            interpreter: 'none',
            cwd: path.join(__dirname, 'packages/frontend'),
            env: {
                NODE_ENV: 'development',
            },
            watch: false,
            autorestart: false,
            kill_timeout: 5000,
            merge_logs: true,
            time: true,
        },

        // Common Package TypeScript Watcher
        {
            name: 'agent-${AGENT_ID}-common-watch',
            script: '../../node_modules/.bin/tsc',
            args: '--build --watch --preserveWatchOutput --incremental tsconfig.build.json',
            interpreter: 'none',
            cwd: path.join(__dirname, 'packages/common'),
            watch: false,
            autorestart: false,
            kill_timeout: 3000,
            merge_logs: true,
            time: true,
        },

        // Warehouses Package TypeScript Watcher
        {
            name: 'agent-${AGENT_ID}-warehouses-watch',
            script: '../../node_modules/.bin/tsc',
            args: '--build --watch --preserveWatchOutput tsconfig.json',
            interpreter: 'none',
            cwd: path.join(__dirname, 'packages/warehouses'),
            watch: false,
            autorestart: false,
            kill_timeout: 3000,
            merge_logs: true,
            time: true,
        },
    ],
};
