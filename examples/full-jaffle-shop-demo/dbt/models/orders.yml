version: 2
models:
  - name: orders
    description: |
      This table has basic information about orders, as well as some derived
      facts based on payments

      {{ doc("orders_status") }}
    config:
      tags: ["ai"]
      meta:
        primary_key: order_id
        spotlight:
          categories:
            - sales
        joins:
          - join: customers
            sql_on: ${customers.customer_id} = ${orders.customer_id}
            relationship: many-to-one
        metrics:
          completion_percentage:
            type: number
            sql: ${total_completed_order_amount}/${total_order_amount}
            format: percent
            ai_hint: |
              Ratio of completed orders to total orders
              Completion percentage of orders.
        default_time_dimension:
          field: order_date
          interval: MONTH
        explores:
          completed_orders:
            label: Completed Orders
            description: Analysis of completed orders with customer information
            group_label: Sales Analysis
            joins:
              - join: customers
                sql_on: ${customers.customer_id} = ${orders.customer_id}
                relationship: many-to-one
            required_filters:
              - is_completed: "true"
    columns:
      - name: order_id
        tests:
          - unique
          - not_null
        description: This is a unique identifier for an order
        config:
          meta:
            metrics:
              unique_order_count:
                type: count_distinct
              completed_order_count:
                label: Completed order count
                description: Total number of completed orders
                type: count_distinct
                filters:
                  - is_completed: "true"
              completed_or_shipped_order_count:
                label: Completed or Shipped Order Count
                type: count_distinct
                filters:
                  - status:
                      - completed
                      - shipped
        meta:
          dimension:
            type: number

      - name: is_completed
        description: Boolean indicating if status is completed
        config:
          meta:
            metrics:
              fulfillment_rate:
                type: average
                format: percent
                round: 1
                sql: CASE WHEN ${is_completed} THEN 1 ELSE 0 END
                show_underlying_values:
                  - amount
                  - customers.first_name
              fulfillment_rate_with_format_expression:
                type: average
                format: "#,##0.0%"
                sql: CASE WHEN ${is_completed} THEN 1 ELSE 0 END
                show_underlying_values:
                  - amount
                  - customers.first_name
        meta:
          dimension:
            type: boolean
      - name: customer_id
        description: Foreign key to the customers table
        tests:
          - not_null
          - relationships:
              to: ref('customers')
              field: customer_id
        meta:
          dimension:
            type: number
      - name: order_date
        description: Date (UTC) that the order was placed
        config:
          meta:
            dimension:
              type: date
              time_intervals: ["DAY", "WEEK", "MONTH", "YEAR"]
            metrics:
              date_of_first_order:
                type: min
              date_of_most_recent_order:
                type: max
        meta:
          dimension:
            type: date
      - name: status
        description: '{{ doc("orders_status") }}'
        config:
          meta:
            dimension:
              colors:
                # Hex colors are supported in both chart config and echarts
                "placed": "#e6fa0f"
                "completed": "#00FF00"
        tests:
          - accepted_values:
              values:
                - placed
                - shipped
                - completed
                - return_pending
                - returned
        meta:
          dimension:
            type: string
      - name: amount
        description: Total amount (USD) of the order
        tests:
          - not_null
        config:
          meta:
            metrics:
              average_order_size:
                type: average
                format: usd
                round: 2
              total_order_amount:
                type: sum
                format: usd
                round: 2
                default_time_dimension:
                  field: order_date
                  interval: DAY
              amount_percent_of_previous:
                type: percent_of_previous
                sql: ${total_order_amount}
                format: "#,##0.00%"
              amount_percent_of_total:
                type: percent_of_total
                sql: ${total_order_amount}
                format: "#,##0.00%"
              amount_running_total:
                type: running_total
                sql: ${total_order_amount}
                format: usd
                round: 2
              total_completed_order_amount:
                type: sum
                format: usd
                round: 2
                filters:
                  - is_completed: "true"
              total_completed_order_amount_eur:
                type: sum
                format: eur
                filters:
                  - is_completed: "true"
              total_non_completed_order_amount:
                type: number
                format: "$#,##0.00"
                sql: ${total_order_amount}-${total_completed_order_amount}
            dimension:
              hidden: true
        meta:
          dimension:
            type: number
      - name: credit_card_amount
        description: Amount of the order (AUD) paid for by credit card
        tests:
          - not_null
        config:
          meta:
            dimension:
              hidden: true
        meta:
          dimension:
            type: number
      - name: coupon_amount
        description: Amount of the order (AUD) paid for by coupon
        tests:
          - not_null
        config:
          meta:
            dimension:
              hidden: true
        meta:
          dimension:
            type: number
      - name: bank_transfer_amount
        description: Amount of the order (AUD) paid for by bank transfer
        tests:
          - not_null
        config:
          meta:
            dimension:
              hidden: true
        meta:
          dimension:
            type: number
      - name: gift_card_amount
        description: Amount of the order (AUD) paid for by gift card
        tests:
          - not_null
        config:
          meta:
            dimension:
              hidden: true
        meta:
          dimension:
            type: number

      - name: order_source
        description: Channel through which the order was placed
        meta:
          dimension:
            type: string
            colors:
              website: "#1f77b4"
              mobile_app: "#ff7f0e"
              phone: "#2ca02c"

      - name: shipping_method
        description: Shipping method selected for the order
        config:
          meta:
            metrics:
              avg_shipping_cost_by_method:
                type: average
                sql: shipping_cost
                format: usd
                round: 2
                label: Average Shipping Cost by Method
              orders_by_shipping_method:
                type: count_distinct
                sql: order_id
                label: Orders by Shipping Method
        meta:
          dimension:
            type: string
            colors:
              standard: "#d62728"
              express: "#ff7f0e"
              overnight: "#2ca02c"

      - name: promo_code
        description: Promotional code applied to the order
        config:
          meta:
            metrics:
              promo_usage_rate:
                type: number
                sql: COUNT(CASE WHEN promo_code IS NOT NULL AND promo_code != '' THEN 1 END)::NUMERIC / COUNT(*)
                format: percent
                round: 1
                label: Promo Code Usage Rate
              orders_with_promos:
                type: count_distinct
                sql: order_id
                filters:
                  - promo_code: IS NOT NULL
                label: Orders with Promo Codes
        meta:
          dimension:
            type: string

      - name: order_priority
        description: Priority level assigned to the order
        config:
          meta:
            metrics:
              avg_delivery_time_by_priority:
                type: average
                sql: estimated_delivery_days
                round: 1
                label: Average Delivery Time by Priority
              priority_distribution:
                type: count_distinct
                sql: order_id
                label: Orders by Priority
        meta:
          dimension:
            type: string
            colors:
              normal: "#1f77b4"
              high: "#ff7f0e"
              urgent: "#d62728"

      - name: estimated_delivery_days
        description: Expected number of days for order delivery
        config:
          meta:
            metrics:
              avg_estimated_delivery:
                type: average
                round: 1
                label: Average Estimated Delivery Days
              orders_by_delivery_speed:
                type: count_distinct
                sql: order_id
                label: Orders by Delivery Speed
            additional_dimensions:
              delivery_speed_tier:
                type: string
                label: Delivery Speed Tier
                sql: |
                  CASE 
                    WHEN ${estimated_delivery_days} = 1 THEN 'Same/Next Day'
                    WHEN ${estimated_delivery_days} <= 3 THEN 'Fast (2-3 days)'
                    WHEN ${estimated_delivery_days} <= 5 THEN 'Standard (4-5 days)'
                    WHEN ${estimated_delivery_days} <= 7 THEN 'Extended (6-7 days)'
                    ELSE 'Slow (8+ days)'
                  END
                colors:
                  "Same/Next Day": "#2ca02c"
                  "Fast (2-3 days)": "#ff7f0e"
                  "Standard (4-5 days)": "#1f77b4"
                  "Extended (6-7 days)": "#ffbb78"
                  "Slow (8+ days)": "#d62728"
        meta:
          dimension:
            type: number

      - name: shipping_cost
        description: Cost of shipping for the order
        config:
          meta:
            metrics:
              total_shipping_revenue:
                type: sum
                format: usd
                label: Total Shipping Revenue
              avg_shipping_cost:
                type: average
                format: usd
                round: 2
                label: Average Shipping Cost
              shipping_cost_vs_order_value:
                type: number
                sql: AVG(shipping_cost / NULLIF(amount, 0))
                format: percent
                round: 2
                label: Shipping Cost as % of Order Value
            additional_dimensions:
              shipping_cost_tier:
                type: string
                label: Shipping Cost Tier
                sql: |
                  CASE 
                  WHEN ${shipping_cost} < 10 THEN 'Low (<$10)'
                  WHEN ${shipping_cost} < 20 THEN 'Medium ($10-$20)'
                  WHEN ${shipping_cost} < 30 THEN 'High ($20-$30)'
                  ELSE 'Premium ($30+)'
                  END
        meta:
          dimension:
            type: number
            format: usd

      - name: tax_rate
        description: Tax rate applied to the order
        config:
          meta:
            metrics:
              avg_tax_rate:
                type: average
                format: percent
                round: 3
                label: Average Tax Rate
              total_tax_collected:
                type: sum
                sql: amount * tax_rate
                format: usd
                label: Total Tax Collected
        meta:
          dimension:
            type: number
            format: percent

      - name: currency
        description: Currency used for the order
        meta:
          dimension:
            type: string

      - name: fulfillment_center
        description: Fulfillment center handling the order
        config:
          meta:
            metrics:
              orders_by_fulfillment_center:
                type: count_distinct
                sql: order_id
                label: Orders by Fulfillment Center
              revenue_by_fulfillment_center:
                type: sum
                sql: amount
                format: usd
                label: Revenue by Fulfillment Center
              avg_shipping_cost_by_center:
                type: average
                sql: shipping_cost
                format: usd
                round: 2
                label: Average Shipping Cost by Center
        meta:
          dimension:
            type: string
            colors:
              east_coast: "#1f77b4"
              west_coast: "#ff7f0e"
              central: "#2ca02c"

      - name: order_notes
        description: Additional notes and context about the order
        meta:
          dimension:
            type: string
            hidden: true
