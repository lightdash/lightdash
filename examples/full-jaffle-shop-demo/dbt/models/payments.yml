version: 2
models:
  - name: payments
    description: This table has information about individual payments
    config:
      tags: ["core", "ai"]
      meta:
        spotlight:
          owner: demo@lightdash.com
        default_show_underlying_values:
          - orders.customer_id
          - unique_payment_count
        sets:
          base_set:
            fields:
              - orders.status
              - orders.shipping_method
              - orders.order_date
              - orders.order_id
          test_set:
            fields:
              - amount
              - base_set*
              - -orders.order_id
        primary_key: payment_id
        joins:
          - join: orders
            sql_on: ${orders.order_id} = ${payments.order_id}
            relationship: many-to-one
          - join: customers
            sql_on: ${customers.customer_id} = ${orders.customer_id}
            relationship: many-to-one
    columns:
      - name: payment_id
        description: This is a unique identifier for a payment
        config:
          meta:
            metrics:
              unique_payment_count:
                type: count_distinct
                description: count of all payments
      - name: order_id
        description: Foreign key to the orders table
      - name: payment_method
        description: Method of payment used, for example credit card
      - name: amount
        description: Total amount (AUD) of the individual payment
        config:
          meta:
            metrics:
              total_order_amount_deduped:
                type: number
                sql: "SUM(DISTINCT (('x' || SUBSTR(MD5(CAST(${orders.order_id} AS VARCHAR)), 1, 15))::BIT(60)::BIGINT) + (${orders.amount})) - SUM(DISTINCT (('x' || SUBSTR(MD5(CAST(${orders.order_id} AS VARCHAR)), 1, 15))::BIT(60)::BIGINT))"
                description: "Total order amount without double-counting from multiple payments per order. Each order's amount is counted once regardless of how many payment rows exist."
                format: usd
                round: 2
              total_order_amount_inflated:
                type: sum
                sql: ${orders.amount}
                description: "Regular SUM of order amount â€” inflated by join fan-out when orders have multiple payments. Compare with total_order_amount_deduped to see the difference."
                format: usd
                round: 2

              total_revenue:
                spotlight:
                  owner: demo2@lightdash.com
                  categories: ['revenue_growth']
                type: sum
                description: Sum of all payments
                # E2E tests rely on these values
                show_underlying_values:
                  # Metrics
                  - test_set*
                  - unique_payment_count
                  - orders.average_order_size
                  - orders.total_order_amount
                  # # Dimensions
                  - orders.customer_id
                drivers:
                  - unique_payment_count
                  - orders.total_order_amount
